name: Ultimate Chrome Remote Gaming

on:
  workflow_dispatch:
    inputs:
      os_choice:
        description: 'ðŸŽ® Select Gaming Platform'
        required: true
        default: 'linux'
        type: choice
        options:
        - windows
        - linux
        - both
      crd_code:
        description: 'ðŸ”‘ Paste your CRD Code from remotedesktop.google.com/headless'
        required: true
        type: string

jobs:
  windows-gaming:
    if: github.event.inputs.os_choice == 'windows' || github.event.inputs.os_choice == 'both'
    runs-on: windows-latest
    timeout-minutes: 525600

    steps:
    - name: Setup Chrome Remote Desktop
      run: |
        Invoke-WebRequest 'https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi' -OutFile 'crd.msi'
        Start-Process msiexec.exe -ArgumentList '/i crd.msi /qn' -Wait
        $ENV:CRP_CODE = "${{ github.event.inputs.crd_code }}"
        & 'C:\Program Files\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe' --code="$ENV:CRP_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$env:computername --pin=123456

    - name: Enable Microsoft Store & AppX
      run: |
        Get-AppXPackage *WindowsStore* -AllUsers | Foreach {Add-AppxPackage -DisableDevelopmentMode -Register "$($_.InstallLocation)\AppXManifest.xml"}
        Get-AppXPackage *StorePurchaseApp* -AllUsers | Foreach {Add-AppxPackage -DisableDevelopmentMode -Register "$($_.InstallLocation)\AppXManifest.xml"}
        Get-AppXPackage *DesktopAppInstaller* -AllUsers | Foreach {Add-AppxPackage -DisableDevelopmentMode -Register "$($_.InstallLocation)\AppXManifest.xml"}

    - name: Setup GPU & Gaming Optimizations
      run: |
        # Install Latest NVIDIA Drivers
        Invoke-WebRequest "https://us.download.nvidia.com/windows/546.33/546.33-desktop-win10-win11-64bit-international-dch-whql.exe" -OutFile "NVIDIA.exe"
        Start-Process -FilePath "NVIDIA.exe" -ArgumentList "/s /n" -Wait
        
        # GPU Optimization
        nvidia-smi -pm 1
        nvidia-smi --auto-boost-default=0
        nvidia-smi -ac 2100,900
        
        # System Performance
        powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games" -Name "GPU Priority" -Value 8
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games" -Name "Priority" -Value 6
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl" -Name "Win32PrioritySeparation" -Value 38

    - name: Keep Active
      run: |
        while($true) {
          Write-Host "ðŸŽ® Windows Gaming Active - $(Get-Date)"
          Start-Sleep -Seconds 300
        }

  linux-gaming:
    if: github.event.inputs.os_choice == 'linux' || github.event.inputs.os_choice == 'both'
    runs-on: ubuntu-latest
    timeout-minutes: 525600

    steps:
    - name: System Update
      run: |
        sudo apt update
        sudo apt upgrade -y
        sudo add-apt-repository ppa:graphics-drivers/ppa -y

    - name: Install Chrome Remote Desktop
      run: |
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo apt install -y ./chrome-remote-desktop_current_amd64.deb
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies
        sudo bash -c 'echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" > /etc/chrome-remote-desktop-session'

    - name: Setup GPU & Gaming Environment
      run: |
        sudo apt install -y nvidia-driver-545 nvidia-settings
        sudo apt install -y lutris wine64
        sudo apt install -y pulseaudio pavucontrol
        sudo apt install -y joystick jstest-gtk mesa-utils
        sudo apt install -y google-chrome-stable
        sudo nvidia-smi -pm 1
        sudo nvidia-smi --auto-boost-default=0
        sudo nvidia-smi -ac 2100,900

    - name: Configure CRD Service
      run: |
        sudo systemctl enable chrome-remote-desktop@$USER
        sudo systemctl start chrome-remote-desktop@$USER
        DISPLAY= /opt/google/chrome-remote-desktop/start-host --code="${{ github.event.inputs.crd_code }}" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$(hostname) --pin=123456

    - name: Setup Gaming User
      run: |
        sudo useradd -m -s /bin/bash gaming
        sudo usermod -aG sudo,audio,video gaming
        echo "gaming:P@ssw0rd!" | sudo chpasswd
        echo "gaming ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/gaming
        sudo chmod 0440 /etc/sudoers.d/gaming

    - name: Keep Active
      run: |
        while true; do
          echo "ðŸŽ® Linux Gaming Active - $(date)"
          sleep 300
        done
