name: Ultimate Gaming System

on: workflow_dispatch

jobs:
  windows-gaming:
    runs-on: windows-latest
    timeout-minutes: 525600

    steps:
    - name: Install AMD Drivers
      run: |
        Invoke-WebRequest "https://drivers.amd.com/drivers/installer/22.40/whql/amd-software-adrenalin-edition-23.12.1-minimalsetup-231205_web.exe" -OutFile "AMD.exe"
        Start-Process -FilePath "AMD.exe" -ArgumentList "-install" -Wait
        
    - name: Optimize AMD GPU
      run: |
        # Enable AMD Radeon RX 6900 XT Settings
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Class\{4d36e968-e325-11ce-bfc1-08002be10318}\0000" -Name "KMD_EnableComputePreemption" -Value 1
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Class\{4d36e968-e325-11ce-bfc1-08002be10318}\0000" -Name "KMD_EnableGPUVirtualization" -Value 1

    - name: Setup Chrome Remote Desktop
      run: |
        curl -L -o chrome_remote_desktop.msi https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi
        Start-Process msiexec.exe -ArgumentList '/i chrome_remote_desktop.msi /qn' -Wait
        $CRP_CODE = "${{ github.event.inputs.crd_code }}"
        & "${env:ProgramFiles}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="$CRP_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$env:computername --pin=123456

    - name: Setup Custom User
      run: |
        Rename-LocalUser -Name "runneradmin" -NewName "droidmaster"
        Set-LocalUser -Name "droidmaster" -Password (ConvertTo-SecureString -AsPlainText "Morales2009" -Force)

  linux-gaming:
    runs-on: ubuntu-latest
    timeout-minutes: 525600

    steps:
    - name: System Update
      run: |
        sudo apt update
        sudo apt upgrade -y
        sudo apt install -y software-properties-common

    - name: Install AMD Drivers
      run: |
        sudo add-apt-repository ppa:oibaf/graphics-drivers -y
        sudo apt update
        sudo apt install -y mesa-vulkan-drivers mesa-vulkan-drivers:i386
        sudo apt install -y libvulkan1 libvulkan1:i386
        sudo apt install -y amdgpu-pro-install
        # Enable RX 6900 XT optimizations
        echo "options amdgpu ppfeaturemask=0xffffffff" | sudo tee /etc/modprobe.d/amdgpu.conf

    - name: Install Chrome Remote Desktop
      run: |
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo apt install -y ./chrome-remote-desktop_current_amd64.deb
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies
        sudo bash -c 'echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" > /etc/chrome-remote-desktop-session'

    - name: Setup Gaming Environment
      run: |
        sudo apt install -y lutris wine64
        sudo apt install -y pulseaudio pavucontrol
        sudo apt install -y joystick jstest-gtk mesa-utils
        sudo apt install -y google-chrome-stable

    - name: Configure CRD Service
      run: |
        sudo systemctl enable chrome-remote-desktop@$USER
        sudo systemctl start chrome-remote-desktop@$USER
        DISPLAY= /opt/google/chrome-remote-desktop/start-host --code="${{ github.event.inputs.crd_code }}" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$(hostname) --pin=123456

    - name: Setup Custom User
      run: |
        sudo useradd -m -s /bin/bash droidmaster
        sudo usermod -aG sudo,audio,video droidmaster
        echo "droidmaster:Morales2009" | sudo chpasswd
        echo "droidmaster ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/droidmaster
        sudo chmod 0440 /etc/sudoers.d/droidmaster

    - name: Keep Active
      run: |
        while true; do
          echo "ðŸŽ® Gaming System Active - $(date)"
          sleep 300
        done
