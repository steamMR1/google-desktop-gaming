name: Ultimate Gaming System

on:
  workflow_dispatch:
    inputs:
      os_choice:
        description: 'ðŸŽ® Select Gaming Platform'
        required: true
        default: 'linux'
        type: choice
        options:
        - windows
        - linux
        - both
      crd_code:
        description: 'ðŸ”‘ Paste your CRD Code from remotedesktop.google.com/headless'
        required: true
        type: string

jobs:
  windows-gaming:
    if: github.event.inputs.os_choice == 'windows' || github.event.inputs.os_choice == 'both'
    runs-on: windows-latest
    timeout-minutes: 525600

    steps:
    - name: Setup AMD GPU
      run: |
        Invoke-WebRequest "https://drivers.amd.com/drivers/installer/22.40/whql/amd-software-adrenalin-edition-23.12.1-minimalsetup-231205_web.exe" -OutFile "AMD.exe"
        Start-Process -FilePath "AMD.exe" -ArgumentList "-install" -Wait
        
    - name: Download Chrome Remote Desktop
      run: |
        curl -L -o chrome_remote_desktop.msi https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi
        Start-Process -FilePath msiexec -ArgumentList '/i chrome_remote_desktop.msi /qn' -Wait

    - name: Configure Remote Access
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

    - name: Setup Chrome Remote Desktop
      run: |
        $CRP_CODE = "${{ github.event.inputs.crd_code }}"
        & "${env:ProgramFiles}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="$CRP_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$env:computername --pin=123456

    - name: Setup Custom User
      run: |
        Rename-LocalUser -Name "runneradmin" -NewName "droidmaster"
        Set-LocalUser -Name "droidmaster" -Password (ConvertTo-SecureString -AsPlainText "Morales2009" -Force)

    - name: Enable Microsoft Store
      run: |
        Get-AppXPackage *WindowsStore* -AllUsers | Foreach {Add-AppxPackage -DisableDevelopmentMode -Register "$($_.InstallLocation)\AppXManifest.xml"}
        Get-AppXPackage *StorePurchaseApp* -AllUsers | Foreach {Add-AppxPackage -DisableDevelopmentMode -Register "$($_.InstallLocation)\AppXManifest.xml"}

    - name: Keep Active
      run: |
        while($true) {
          Write-Host "ðŸŽ® Windows Gaming Ready! $(Get-Date)"
          Start-Sleep -Seconds 300
        }

  linux-gaming:
    if: github.event.inputs.os_choice == 'linux' || github.event.inputs.os_choice == 'both'
    runs-on: ubuntu-latest
    timeout-minutes: 525600

    steps:
    - name: System Update
      run: |
        sudo apt update
        sudo apt upgrade -y
        sudo apt install -y software-properties-common

    - name: Install AMD Drivers
      run: |
        sudo dpkg --add-architecture i386
        sudo add-apt-repository ppa:oibaf/graphics-drivers -y
        sudo apt update
        sudo apt install -y mesa-vulkan-drivers mesa-vulkan-drivers:i386
        sudo apt install -y libvulkan1 libvulkan1:i386
        sudo apt install -y amdgpu-pro-install
        sudo apt install -y rocm-opencl-runtime
        # Virtual AMD RX 6900 XT Configuration
        echo 'SUBSYSTEM=="drm", KERNEL=="card[0-9]*", ATTRS{vendor}=="0x1002", ATTRS{device}=="0x73bf", MODE="0666"' | sudo tee /etc/udev/rules.d/70-amdgpu.rules

    - name: Install Chrome Remote Desktop
      run: |
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo apt install -y ./chrome_remote_desktop_current_amd64.deb
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies
        sudo bash -c 'echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" > /etc/chrome-remote-desktop-session'

    - name: Setup Gaming Environment
      run: |
        sudo apt install -y lutris wine64
        sudo apt install -y pulseaudio pavucontrol
        sudo apt install -y joystick jstest-gtk mesa-utils
        sudo apt install -y google-chrome-stable

    - name: Configure CRD Service
      run: |
        sudo systemctl enable chrome-remote-desktop@$USER
        sudo systemctl start chrome-remote-desktop@$USER
        DISPLAY= /opt/google/chrome-remote-desktop/start-host --code="${{ github.event.inputs.crd_code }}" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$(hostname) --pin=123456

    - name: Setup Custom User
      run: |
        sudo useradd -m -s /bin/bash droidmaster
        sudo usermod -aG sudo,audio,video,render droidmaster
        echo "droidmaster:Morales2009" | sudo chpasswd
        echo "droidmaster ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/droidmaster
        sudo chmod 0440 /etc/sudoers.d/droidmaster

    - name: Keep Active
      run: |
        while true; do
          echo "ðŸŽ® Gaming System Active - $(date)"
          sleep 300
        done
